'use strict';function e(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}function r(r,n){var it;if("undefined"==typeof Symbol||null==r[Symbol.iterator]){if(Array.isArray(r)||(it=function(r,n){if(r){if("string"==typeof r)return e(r,n);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?e(r,n):void 0}}(r))||n&&r&&"number"==typeof r.length){it&&(r=it);var t=0;return function(){return t>=r.length?{done:1}:{done:0,value:r[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(it=r[Symbol.iterator]()).next.bind(it)}function n(e){for(var r=void 0===e?{}:e,n=r.node,t=void 0===n?[]:n,a=r.parent,o=r.child,i=void 0===o?r.to||r.target:o,u=r.scope,f=void 0===u?{}:u,c=r.meta,s=void 0===c?{}:c,l=r.family,p=void 0===l?{type:'regular'}:l,d=pe(void 0===a?r.from||r.source:a),v=pe(p.links),m=pe(p.owners),h=[],g={},y=0;y<t.length;y++){var b=t[y];b&&(h.push(b),de(b,g))}for(var k={id:_(),seq:h,next:pe(i),meta:s,scope:f,family:{type:p.type||"crosslink",links:v,owners:m},reg:g},w=0;w<v.length;w++)ne(v[w]).push(k);for(var x=0;x<m.length;x++)te(m[x]).push(k);for(var S=0;S<d.length;S++)d[S].next.push(k);return k}function t(e,r){void 0===r&&(r='combine');var n=r+'(',t='',a=0;for(var o in e){var i=e[o];if(null!=i&&(n+=t,n+=S(i)?i.compositeName.fullName:i.toString()),25===(a+=1))break;t=', '}return n+')'}function a(e,r){var n,t,a,o=e;return r?(a=r.compositeName,0===e.length?(n=a.path,t=a.fullName):(n=a.path.concat([e]),t=0===a.fullName.length?e:a.fullName+'/'+e)):(n=0===e.length?[]:[e],t=e),{shortName:o,fullName:t,path:n}}function o(e,r){e.forEach(r)}function i(e,r){var n=re(e).meta;$e={parent:$e,value:e,template:n.template||Je(),sidRoot:n.sidRoot||$e&&$e.sidRoot};try{return r()}finally{$e=ce($e)}}function u(e,r,n,t){var a=je,o=null;if(r)for(o=je;o&&o.template!==r;)o=ce(o);Ce(o);var i=e.create(n,t);return Ce(a),i}function f(e,r){var t=function e(r){for(var n=arguments.length,t=new Array(n>1?n-1:0),o=1;o<n;o++)t[o-1]=arguments[o];return je?u(e,a,r,t):e.create(r,t)};t.graphite=n({meta:Ze("event",t,r,e)}),t.create=function(e){var r=ye?ye.find(t):t;return Pe(r,e),e},t.watch=z(Ve,t),t.map=function(e){var r,n;R(e)&&(r=e,n=e.name,e=e.fn);var a=f(Ie(t,n),r);return rr(t,a,w,e),a},t.filter=function(e){return nr(t,"filter",e.fn?e:e.fn,[J({fn:ee})])},t.filterMap=function(e){return nr(t,'filterMap',e,[$({fn:ee}),G.defined()])},t.prepend=function(e){var r=f('* → '+t.shortName,{parent:ce(t)}),n=Je();return n&&re(r).seq.push(n.upward),rr(r,t,'prepend',e),Ye(t,r),r};var a=Je();return Ge(t)}function c(e,t){function a(e,r){l.off(e),fe(l).set(e,Be(tr(e,l,'on',1,r)))}var o=V(e),i=V(e),u=er('updates'),f=Je();o.after=[{type:'copy',to:i}],f&&f.plain.push(o,i);var s=o.id,l={subscribers:new Map,updates:u,defaultState:e,stateRef:o,getState:function(){var e,r=o;if(je){for(var n=je;n&&!n.reg[s];)n=ce(n);n&&(e=n)}return!e&&ye&&ye.reg[s]&&(e=ye),e&&(r=e.reg[s]),X(r)},setState:function(e){var r;ye&&(r=ye.nodeMap[re(l).id]),r||(r=l),Pe({target:r,params:e,defer:1})},reset:function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];for(var t=0,a=r;t<a.length;t++){var o=a[t];l.on(o,(function(){return l.defaultState}))}return l},on:function(e,n){if(Array.isArray(e))for(var t,o=r(e);!(t=o()).done;)a(t.value,n);else a(e,n);return l},off:function(e){var r=fe(l).get(e);return r&&(r(),fe(l).delete(e)),l},map:function(e,r){var n,t,a;R(e)&&(n=e,t=e.name,r=e.firstState,e=e.fn);var i=l.getState(),u=Je();u?a=null:void 0!==i&&(a=e(i,r));var f=c(a,{name:Ie(l,t),config:n,strict:0}),s=tr(l,f,w,0,e);return ae(f).before=[{type:w,fn:e,from:o}],u&&(_e(u.plain,o)||_e(s.seq,u.loader)||s.seq.unshift(u.loader)),f},watch:function(e,r){if(!r||!S(e)){var n=Ve(l,e),t=Je();return t?t.watch.push({of:o,fn:e}):e(l.getState()),n}return D(r)||P('second argument should be a function'),e.watch((function(e){return r(l.getState(),e)}))}};return l.graphite=n({scope:{state:o},node:[G.defined(),L({store:o}),G.changed({store:i}),L({store:i})],child:u,meta:Ze(k,l,t)}),be&&void 0===e&&P("current state can't be undefined, use null instead"),le(l,[u]),Ge(l)}function s(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var t,a,o;Me(r[0],(function(e,n){o=e,r=n}));var i,u,f=r[r.length-1];if(D(f)?(a=r.slice(0,-1),t=f):a=r,1===a.length){var c=a[0];N(c)||(i=c,u=1)}return u||(i=a,t&&(t=ar(t))),R(i)||P('shape should be an object'),or(Array.isArray(i),i,o,t)}function l(){var e={};return e.req=new Promise((function(r,n){e.rs=r,e.rj=n})),e.req.catch((function(){})),e}function p(e,r){var t=f(e,r),a=t.defaultConfig.handler||function(){return P("no handler used in "+t.getType())},o=re(t);o.meta.onCopy=['runner'],o.meta.unit=t.kind="effect",t.use=function(e){return D(e)||P('.use argument should be a function'),a=e,t};var i=t.finally=er('finally'),u=t.done=i.filterMap({named:'done',fn:function(e){if('done'===e.status)return{params:e.params,result:e.result}}}),s=t.fail=i.filterMap({named:'fail',fn:function(e){if('fail'===e.status)return{params:e.params,error:e.error}}}),p=t.doneData=u.map({named:'doneData',fn:function(e){return e.result}}),d=t.failData=s.map({named:'failData',fn:function(e){return e.error}}),v=n({scope:{getHandler:t.use.getCurrent=function(){return a},finally:i},node:[K({fn:function(e,r,n){var t,a=e.params,o=e.req,i=r.finally,u=r.getHandler,f=ir({params:a,req:o,ok:1,anyway:i,stack:n}),c=ir({params:a,req:o,ok:0,anyway:i,stack:n});try{t=u()(a)}catch(s){return void c(s)}R(t)&&D(t.then)?t.then(f,c):f(t)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});o.scope.runner=v,o.seq.push($({fn:function(e,r,n){return ce(n)?{params:e,req:{rs:function(){},rj:function(){}}}:e}}),K({fn:function(e,r,n){return Pe({target:r.runner,params:e,defer:1,forkPage:se(n)}),e.params}})),t.create=function(e){var r=l(),n={params:e,req:r};if(ye){if(!Ae){var a=ye;r.req.finally((function(){Oe(a)}))}Pe(ye.find(t),n)}else Pe(t,n);return r.req};var m=t.inFlight=c(0,{named:'inFlight'}).on(t,(function(e){return e+1})).on(i,(function(e){return e-1})),h=t.pending=m.map({fn:function(e){return e>0},named:'pending'});return le(t,[i,u,s,p,d,h,m,v]),t}function d(){for(var e,r,t=arguments.length,a=new Array(t),o=0;o<t;o++)a[o]=arguments[o];var i,u,l=Ee(a),p=l[0],d=p[0],v=p[1],m=p[2],h=l[1];void 0===v&&'source'in d&&('clock'in d&&null==d.clock&&P('config.clock should be defined'),v=d.clock,m=d.fn,u=d.greedy,e=d.target,r=d.name,i=d.sid,d=d.source),S(d)||(d=s(d)),void 0===v&&(v=d),r=h||r||d.shortName;var g=Je(),y=!!e;if(!e)if(N(d)&&N(v)){var b=m?m(X(ae(d)),X(ae(v))):X(ae(d));e=c(b,{name:r,sid:i})}else e=f(r),g&&re(e).seq.push(g.loader);var w=y&&S(e)&&re(e).meta.nativeTemplate;if(N(d)){var q=ae(d);le(d,[Le(v,e,{scope:{fn:m,targetTemplate:w},node:[g&&g.loader,!u&&U({priority:"sampler"}),B({store:q,to:m?"a":x}),m&&$({fn:Z}),g&&y&&g.upward],meta:{op:"sample",sample:k}})]),g&&(_e(g.plain,q)||_e(g.closure,q)||g.closure.push(q))}else{var A=V(0),j=V(),O=V();g&&g.plain.push(A,j,O),Ge(n({parent:d,node:[L({store:j}),B({from:"value",store:1,target:A})],family:{owners:[d,e,v],links:e},meta:{op:"sample",sample:'source'}})),le(d,[Le(v,e,{scope:{fn:m,targetTemplate:w},node:[g&&g.loader,L({store:O}),B({store:A}),J({fn:function(e){return e}}),!u&&U({priority:"sampler"}),B({store:j}),B({store:O,to:"a"}),m&&$({fn:Y}),g&&y&&g.upward],meta:{op:"sample",sample:'clock'}})])}return e}function v(e){for(var r=Object.values(e),n={},t=0,a=r;t<a.length;t++)n[a[t].id]=[];for(var i=function(){var e=f[u],r=e.id,t=e.before,a=e.after;t&&o(t,(function(e){n[e.from.id].push(r)})),a&&o(a,(function(e){n[r].push(e.to.id)}))},u=0,f=r;u<f.length;u++)i();return n}function m(e){if(e instanceof Map){for(var n,t={},a=r(e);!(n=a()).done;){var o=n.value,i=o[0],u=o[1];S(i)||P('Map key should be a unit'),t[i.sid]=u}return t}return e}function h(e,r){function n(e){f[e]=1;for(var r=t[e],a=0;a<r.length;a++){var o=r[a];f[o]||u[o]||n(o)}f[e]=0,u[e]=1,i.push(e)}var t={};for(var a in e)t[a]=[].concat(new Set(e[a]));var i=[],u={},f={};for(var c in t)u[c]||f[c]||n(c);return i.reverse(),r&&r.size>0&&function(){for(var e,n=[],a=[].concat(r);e=a.shift();)n.push(e),o(t[e],(function(e){_e(n,e)||_e(a,e)||a.push(e)}));o(n,(function(e){ze(i,e)}))}(),i}function g(e){var r=[];return function e(n){_e(r,n)||(r.push(n),y(n,e))}(re(e)),r}function y(e,r){var n=e.meta.unit;'fork'!==n&&"forkInFlightCounter"!==n&&(o(e.next,r),o(ne(e),r),o(te(e),r))}Object.defineProperty(exports,'__esModule',{value:1});for(var b='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',k='store',w='map',x='stack',S=function(e){return(D(e)||R(e))&&'kind'in e},q=function(e){return function(r){return S(r)&&r.kind===e}},N=q(k),A=q("event"),j=q("effect"),O=q("domain"),C={__proto__:null,unit:S,store:N,event:A,effect:j,domain:O},P=function(e){throw Error(e)},R=function(e){return'object'==typeof e&&null!==e},D=function(e){return'function'==typeof e},I=function(e){R(e)||D(e)||P('expect first argument be an object')},M=function(){var e=0;return function(){return(++e).toString(36)}},E=M(),F=M(),_=M(),z=function(e,r){return e.bind(null,r)},T=function(e,r,n){return e.bind(null,r,n)},W=function(e,r,n){return{id:F(),type:e,data:n,hasRef:r}},H=0,U=function(e){var r=e.priority;return W("barrier",0,{barrierID:++H,priority:void 0===r?"barrier":r})},B=function(e){var r=e.from,n=void 0===r?k:r,t=e.target,a=e.to;return W('mov',n===k,{from:n,store:e.store,to:void 0===a?t?k:x:a,target:t})},G={defined:function(){return W('check',0,{type:'defined'})},changed:function(e){return W('check',1,{type:'changed',store:e.store})}},$=T(W,'compute',0),J=T(W,"filter",0),K=T(W,'run',0),L=function(e){return B({from:x,target:e.store})},Q={__proto__:null,barrier:U,mov:B,check:G,compute:$,filter:J,run:K,update:L},V=function(e){return{id:F(),current:e}},X=function(e){return e.current},Y=function(e,r,n){return(0,r.fn)(e,n.a)},Z=function(e,r,n){return(0,r.fn)(n.a,e)},ee=function(e,r){return(0,r.fn)(e)},re=function(e){return e.graphite||e},ne=function(e){return e.family.owners},te=function(e){return e.family.links},ae=function(e){return e.stateRef},oe=function(e){return e.config},ie=function(e){return e.ɔ},ue=function(e){return e.value},fe=function(e){return e.subscribers},ce=function(e){return e.parent},se=function(e){return e.forkPage},le=function(e,r){for(var n=re(e),t=0;t<r.length;t++){var a=re(r[t]);"domain"!==n.family.type&&(a.family.type="crosslink"),ne(a).push(n),te(n).push(a)}},pe=function(e){void 0===e&&(e=[]);var r=[];if(Array.isArray(e))for(var n=0;n<e.length;n++)Array.isArray(e[n])?r.push.apply(r,e[n]):r.push(e[n]);else r.push(e);return r.map(re)},de=function(e,r){var n,t=e.type,a=e.data;e.hasRef&&(r[(n=a.store).id]=n),'mov'===t&&a.to===k&&(r[(n=a.target).id]=n)},ve=null,me=function e(r,n){if(!r)return n;if(!n)return r;var t,a=r.v.type===n.v.type;return(a&&r.v.id>n.v.id||!a&&"sampler"===r.v.type)&&(t=r,r=n,n=t),t=e(r.r,n),r.r=r.l,r.l=t,r},he=[],ge=0;ge<5;)he.push({first:null,last:null,size:0}),ge+=1;var ye,be,ke=function(){for(var e=0;e<5;e++){var r=he[e];if(r.size>0){if(2===e||3===e){r.size-=1;var n=ve.v;return ve=me(ve.l,ve.r),n}1===r.size&&(r.last=null);var t=r.first;return r.first=t.r,r.size-=1,t.v}}},we=function(e,r,n,t,a,o){return xe(0,{a:null,b:null,node:n,parent:t,value:a,page:r,forkPage:o},e)},xe=function(e,r,n,t){void 0===t&&(t=0);var a=Se(n),o=he[a],i={v:{idx:e,stack:r,type:n,id:t},l:0,r:0};2===a||3===a?ve=me(ve,i):(0===o.size?o.first=i:o.last.r=i,o.last=i),o.size+=1},Se=function(e){switch(e){case'child':return 0;case'pure':return 1;case"barrier":return 2;case"sampler":return 3;case"effect":return 4;default:return-1}},qe=new Set,Ne=1,Ae=0,je=null,Oe=function(e){ye=e},Ce=function(e){je=e},Pe=function(e,r,n){var t=je,a=null,o=ye;if(e.target&&(r=e.params,n=e.defer,t='page'in e?e.page:t,e.stack&&(a=e.stack),o=se(e)||o,e=e.target),Array.isArray(e))for(var i=0;i<e.length;i++)we('pure',t,re(e[i]),a,r[i],o);else we('pure',t,re(e),a,r,o);n&&!Ne||function(){var e,r,n,t,a,o,i={isRoot:Ne,currentPage:je,forkPage:ye,isWatch:Ae};Ne=0;e:for(;t=ke();){var u=t.idx,f=t.stack,c=t.type;n=f.node,je=a=f.page,ye=se(f),o=(a||n).reg;var s={fail:0,scope:n.scope};e=r=0;for(var l=u;l<n.seq.length&&!e;l++){var p=n.seq[l],d=p.data;switch(p.type){case"barrier":var v=d.barrierID;a&&(v=a.fullID+"_"+v);var m=d.priority;if(l!==u||c!==m){qe.has(v)||(qe.add(v),xe(l,f,m,v));continue e}qe.delete(v);break;case'mov':var h=void 0;switch(d.from){case x:h=ue(f);break;case"a":case'b':h=f[d.from];break;case"value":h=d.store;break;case k:o[d.store.id]||(f.page=a=null,o=n.reg),h=X(o[d.store.id])}switch(d.to){case x:f.value=h;break;case"a":case'b':f[d.to]=h;break;case k:o[d.target.id].current=h}break;case'check':switch(d.type){case'defined':r=void 0===ue(f);break;case'changed':r=ue(f)===X(o[d.store.id])}break;case"filter":r=!Re(s,d,f);break;case'run':if(l!==u||"effect"!==c){xe(l,f,"effect");continue e}case'compute':Ae='watch'===n.meta.op,f.value=Re(s,d,f),Ae=i.isWatch}e=s.fail||r}if(!e)for(var g=0;g<n.next.length;g++)we('child',a,n.next[g],f,ue(f),se(f))}Ne=i.isRoot,je=i.currentPage,ye=se(i)}()},Re=function(e,r,n){var t=r.fn;try{return t(ue(n),e.scope,n)}catch(a){console.error(a),e.fail=1}},De=function(e,r){return''+e.shortName+r},Ie=function(e,r){return null==r?De(e,' → *'):r},Me=function(e,r){I(e),ie(e)&&r(oe(e),ie(e))},Ee=function(e){var r;return Me(e[0],(function(n,t){r=n,e=t})),[e,r]},Fe=function(e,r){for(var n in e)r(e[n],n)},_e=function(e,r){return e.includes(r)},ze=function(e,r){var n=e.indexOf(r);-1!==n&&e.splice(n,1)},Te=function(e,r){ze(e.next,r),ze(ne(e),r),ze(te(e),r)},We=function e(r,n,t){var a;r.next.length=0,r.seq.length=0,r.scope=null;for(var o=te(r);a=o.pop();)Te(a,r),(n||t&&!r.meta.sample||"crosslink"===a.family.type)&&e(a,n,'on'!==a.meta.op&&t);for(o=ne(r);a=o.pop();)Te(a,r),t&&"crosslink"===a.family.type&&e(a,n,'on'!==a.meta.op&&t)},He=function(e){return e.clear()},Ue=function(e,r){var n=(void 0===r?{}:r).deep,t=0;if(e.ownerSet&&e.ownerSet.delete(e),N(e))He(fe(e));else if(O(e)){t=1;var a=e.history;He(a.events),He(a.effects),He(a.stores),He(a.domains)}We(re(e),!!n,t)},Be=function(e){var r=T(Ue,e,void 0);return r.unsubscribe=r,r},Ge=function(e){return $e&&le(ue($e),[e]),e},$e=null,Je=function(){return $e&&$e.template},Ke=function(e){return e&&$e&&$e.sidRoot&&(e=$e.sidRoot+"ɔ"+e),e},Le=function(e,r,t){return Ge(n({node:t.node,parent:e,child:r,scope:t.scope,meta:t.meta,family:{owners:[e,r],links:r}}))},Qe=function(e){var r;Me(e,(function(n,t){r=n,e=t}));var t=e.from,a=e.to,o=e.meta,i=void 0===o?{op:'forward'}:o;return t&&a||P('from and to fields should be defined'),r&&(i.config=r),Be(Ge(n({parent:t,child:a,meta:i,family:{}})))},Ve=function(e,r){if(D(r)||P('.watch argument should be a function'),ye){var t=ye.nodeMap[re(e).id];t&&(e=t)}return Be(Ge(n({scope:{fn:r},node:[K({fn:ee})],parent:e,meta:{op:'watch'},family:{owners:e}})))},Xe=function e(r,n){return R(r)&&(e(oe(r),n),null!=r.name&&(R(r.name)?e(r.name,n):D(r.name)?n.handler=r.name:n.name=r.name),r.loc&&(n.loc=r.loc),(r.sid||null===r.sid)&&(n.sid=r.sid),r.handler&&(n.handler=r.handler),ce(r)&&(n.parent=ce(r)),'strict'in r&&(n.strict=r.strict),r.named&&(n.named=r.named),e(ie(r),n)),n},Ye=function(e,r,n){void 0===n&&(n="event"),ce(e)&&ce(e).hooks[n](r)},Ze=function(e,r,n,t){var o=Xe({name:t,config:n},{}),i="domain"===e,u=E(),f=o.parent,c=void 0===f?null:f,s=o.sid,l=void 0===s?null:s,p=o.strict,d=void 0===p?1:p,v=o.named,m=void 0===v?null:v,h=m||o.name||(i?'':u),g=a(h,c),y={unit:r.kind=e,name:r.shortName=h,sid:r.sid=Ke(l),named:m,unitId:r.id=u};if(r.parent=c,r.compositeName=g,r.defaultConfig=o,r.thru=function(e){return e(r)},r.getType=function(){return g.fullName},!i){r.subscribe=function(e){return I(e),r.watch(D(e)?e:function(r){e.next&&e.next(r)})},r[b]=function(){return r};var k=Je();k&&(y.nativeTemplate=k)}return be=d,y},er=function(e){return f({named:e})},rr=function(e,r,n,t){return Le(e,r,{scope:{fn:t},node:[$({fn:ee})],meta:{op:n}})},nr=function(e,r,n,t){var a;R(n)&&(a=n,n=n.fn);var o=f(De(e,' →? *'),a);return Le(e,o,{scope:{fn:n},node:t,meta:{op:r}}),o},tr=function(e,r,n,t,a){var o=ae(r),i=[B({store:o,to:"a"}),$({fn:t?Z:Y}),G.defined(),G.changed({store:o}),L({store:o})],u=Je();if(u&&(i.unshift(u.loader),i.push(u.upward),N(e))){var f=ae(e);_e(u.plain,f)||(_e(u.closure,f)||u.closure.push(f),o.before||(o.before=[]),o.before.push({type:'closure',of:f}))}return Le(e,r,{scope:{fn:a},node:i,meta:{op:n}})},ar=function(e){return function(r){return e.apply(void 0,r)}},or=function(e,r,n,a){var o=e?function(e){return e.slice()}:function(e){return Object.assign({},e)},i=e?[]:{},u=Je(),f=o(i),s=V(f),l=V(1);s.type=e?'list':'shape',u&&u.plain.push(s,l);var p=c(f,{name:n||t(r)}),d=[G.defined(),B({store:s,to:"a"}),J({fn:function(e,r,n){return e!==n.a[r.key]}}),B({store:l,to:'b'}),$({fn:function(e,r,n){var t=r.key;n.b&&(n.a=(0,r.clone)(n.a)),n.a[t]=e}}),B({from:"a",target:s}),B({from:"value",store:0,target:l}),U({priority:"barrier"}),B({from:"value",store:1,target:l}),B({store:s}),a&&$({fn:a}),G.changed({store:ae(p)})],v=s.before=[];return Fe(r,(function(e,r){if(N(e)){i[r]=e.defaultState,f[r]=e.getState();var n=Le(e,p,{scope:{key:r,clone:o},node:d,meta:{op:'combine'}}),t=ae(e);v.push({type:'field',field:r,from:t}),u&&(_e(u.plain,t)||n.seq.unshift(u.loader))}else f[r]=i[r]=e})),p.defaultShape=r,s.after=[a?{type:w,to:ae(p),fn:a}:{type:'copy',to:ae(p)}],u||(p.defaultState=a?ae(p).current=a(f):i),p},ir=function(e){var r=e.params,n=e.req,t=e.ok,a=e.anyway,o=e.stack;return function(e){return Pe({target:[a,ur],params:[t?{status:'done',params:r,result:e}:{status:'fail',params:r,error:e},{fn:t?n.rs:n.rj,value:e}],defer:1,page:o.page,forkPage:se(o)})}},ur=n({node:[K({fn:function(e){(0,e.fn)(e.value)}})],meta:{op:'fx',fx:'sidechain'}}),fr=function(e,r,n){return e.watch((function(e){le(n,[e]),r.add(e),e.ownerSet||(e.ownerSet=r),ce(e)||(e.parent=n)})),le(n,[e]),function(n){return r.forEach(n),e.watch(n)}};exports.allSettled=function(e,r){var n=r.scope,t=r.params;if(!S(e))return Promise.reject(Error('first argument should be unit'));var a=l();a.parentFork=ye;var o=n.graphite.scope.forkInFlightCounter;o.scope.defers.push(a);var i=[n.find(e)],u=[];return j(e)?u.push({params:t,req:{rs:function(e){a.value={status:'done',value:e}},rj:function(e){a.value={status:'fail',value:e}}}}):u.push(t),i.push(o),u.push(null),Pe({target:i,params:u,forkPage:n}),a.req},exports.attach=function(e){var r,n;Me(e,(function(r,t){n=r,e=t}));var t=e.source,a=e.effect,o=e.mapParams;o||(o=t?function(e,r){return r}:function(e){return e});var i,u=p(e,n),f=re(u).scope.runner,c=function(e,r,n){var t,a=e.params,i=e.req,u=r.finally,f=r.effect,c=ir({params:a,req:i,ok:0,anyway:u,stack:n});try{t=o(a,n.a)}catch(s){return c(s)}Pe({target:f,params:{params:t,req:{rs:ir({params:a,req:i,ok:1,anyway:u,stack:n}),rj:c}},page:n.page,defer:1})};if(t){var l;N(t)?l=t:(l=s(t),le(u,[l]));var d=B({from:k,store:ae(l),to:"a"});i=[K({fn:function(e){return e}}),d,$({fn:c})],de(d,f.reg)}else i=[K({fn:c})];return f.scope.effect=a,f.meta.onCopy.push("effect"),(r=f.seq).splice.apply(r,[0,1].concat(i)),Ye(a,u,"effect"),u},exports.clearNode=Ue,exports.combine=s,exports.createApi=function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var t=Ee(r),a=t[0],o=a[0],i=a[1],u=t[1],c={};return Fe(i,(function(e,r){var n=c[r]=f(r,{parent:ce(o),config:u});o.on(n,e),Ye(o,n)})),c},exports.createDomain=function e(r,t){var a=new Set,o=new Set,i=new Set,u=new Set,s=n({family:{type:"domain"}}),l={history:{domains:a,stores:o,effects:i,events:u},graphite:s};s.meta=Ze("domain",l,t,r);var d=['onEvent','onEffect','onStore','onDomain'].map(er),v=d[0],m=d[1],h=d[2],g=d[3];l.hooks={event:v,effect:m,store:h,domain:g},l.onCreateEvent=fr(v,u,l),l.onCreateEffect=fr(m,i,l),l.onCreateStore=fr(h,o,l),l.onCreateDomain=fr(g,a,l),l.createEvent=l.event=function(e,r){return v(f(e,{parent:l,config:r}))},l.createEffect=l.effect=function(e,r){return m(p(e,{parent:l,config:r}))},l.createDomain=l.domain=function(r,n){return e({name:r,parent:l,config:n})},l.createStore=l.store=function(e,r){return h(c(e,{parent:l,config:r}))},Ge(l);var y=ce(l);return y&&(Fe(l.hooks,(function(e,r){Qe({from:e,to:y.hooks[r]})})),y.hooks.domain(l)),l},exports.createEffect=p,exports.createEvent=f,exports.createNode=n,exports.createStore=c,exports.createStoreObject=s,exports.fork=function(e,t){var a=void 0===t?{}:t,i=a.values,u=a.handlers;O(e)||P('first argument of fork should be domain');var f=!!i;i=m(i||{});var c=function(e){function r(e){var r=re(e),n=t.indexOf(r);if(-1===n){var a='unit';e!==r&&e.id!==e.shortName&&(a=e.shortName),P(a+" not found in forked scope")}return s[n]}var t=g(e),a=new Map,i=$({fn:function(e,r,n){return Oe(se(n)),e}}),u=n({scope:{defers:[],inFlight:0,fxID:0},node:[$({fn:function(e,r,n){n.parent?'finally'===n.parent.node.meta.named?r.inFlight-=1:(r.inFlight+=1,r.fxID+=1):r.fxID+=1}}),U({priority:"sampler"}),K({fn:function(e,r){var n=r.defers,t=r.fxID;r.inFlight>0||0===n.length||Promise.resolve().then((function(){r.fxID===t&&o(n.splice(0,n.length),(function(e){Oe(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),f={},c={},s=t.map((function(e){var r=e.next,t=e.meta,a=e.scope,o=n({node:e.seq.map((function(e){return{id:e.id,type:e.type,data:Object.assign({},e.data),hasRef:e.hasRef}})),child:[].concat(r),meta:Object.assign({forkOf:e},t),scope:Object.assign({},a)});return o.family={type:e.family.type,links:[].concat(te(e)),owners:[].concat(ne(e))},f[e.id]=o,t.sid&&(c[t.sid]=o),o})),l={};return o(s,(function(e){var n=e.reg,t=e.scope,o=e.meta,f=o.onCopy,c=o.op,s=o.unit;for(var p in n){var d=n[p],v=a.get(d);v||a.set(d,v={id:d.id,current:d.current}),l[p]=n[p]=v}if(f)for(var m=0;m<f.length;m++)t[f[m]]=r(t[f[m]]);switch(y(e,(function(e,n,t){t[n]=r(e)})),c||s){case k:e.meta.wrapped=function(e){return{kind:k,getState:function(){return e.reg[e.scope.state.id].current},updates:{watch:z(Ve,e)},graphite:e,family:e.family}}(e);break;case"event":e.seq.unshift(i);break;case"effect":e.next.push(u),e.seq.unshift(i);break;case'fx':t.finally.next.push(u),e.seq.unshift(i);break;case'watch':e.seq.unshift(i)}})),{cloneOf:e,nodeMap:f,sidMap:c,clones:s,find:r,reg:l,getState:function(e){return r(e).meta.wrapped.getState()},graphite:n({family:{type:"domain",links:[u].concat(s)},meta:{unit:'fork'},scope:{forkInFlightCounter:u}})}}(e);if(f&&function(){for(var n,t=g(e),a={},u={},f=new Set,s=new Set,l=Object.getOwnPropertyNames(i),p=r(t);!(n=p()).done;){var d=n.value,m=d.reg,y=d.meta.nativeTemplate;for(var b in m)a[b]=m[b],y&&s.add(b)}for(var x,S=r(c.clones);!(x=S()).done;){var q=x.value,N=q.reg,A=q.meta,j=A.sid;if(A.unit===k&&j&&_e(l,j)){var O=q.scope.state;N[O.id].current=i[j],f.add(O)}for(var C in N)u[C]=N[C]}o(h(v(a),s),(function(e){(function(e,n){var t=0;if(n&&n.before&&!f.has(e))for(var a,o=r(n.before);!(a=o()).done;){var i=a.value;switch(i.type){case w:e.current=i.fn(u[i.from.id].current);break;case'field':var c=u[i.from.id];t||(t=1,e.current=Array.isArray(e.current)?[].concat(e.current):Object.assign({},e.current)),e.current[i.field]=c.current}}if(n&&n.after)for(var s,l=e.current,p=r(n.after);!(s=p()).done;){var d=s.value,v=u[d.to.id];switch(d.type){case'copy':v.current=l;break;case w:v.current=d.fn(l)}}})(u[e],a[e])}))}(),u){u=m(u);for(var s,l=Object.keys(u),p=function(){var e=s.value,r=e.scope,n=e.meta;n.sid&&_e(l,n.sid)&&(r.runner.scope.getHandler=function(){return u[n.sid]})},d=r(c.clones);!(s=d()).done;)p()}return c},exports.forward=Qe,exports.fromObservable=function(e){I(e);var r=b in e?e[b]():e;r.subscribe||P('expect observable to have .subscribe');var n=f(),t=T(Ue,n,void 0);return r.subscribe({next:n,error:t,complete:t}),n},exports.guard=function(){for(var e={op:'guard'},r='guard',t=arguments.length,a=new Array(t),o=0;o<t;o++)a[o]=arguments[o];var i=Ee(a),u=i[0],c=u[0],l=u[1],p=i[1];p&&(e.config=p,p.name&&(r=p.name)),l||(c=(l=c).source);var v=l,m=v.filter,h=v.greedy,g=v.name,y=void 0===g?r:g,b=l.target||f(y,e.config);return S(c)||(c=s(c)),S(m)?d({source:m,clock:c,target:Ge(n({node:[J({fn:function(e){return e.guard}}),$({fn:function(e){return e.data}})],child:b,meta:e,family:{owners:[c,m,b],links:b}})),fn:function(e,r){return{guard:e,data:r}},greedy:h,name:y}):(D(m)||P('`filter` should be function or unit'),Le(c,b,{scope:{fn:m},node:[J({fn:ee})],meta:e})),b},exports.hydrate=function(e,n){var t=n.values,a=R(e)&&e.cloneOf;O(e)||a||P('first argument of hydrate should be domain or scope'),R(t)||P('values property should be an object');var i,u,f=m(t);if(a)i=[],u=[],Fe(f,(function(r,n){var t=e.sidMap[n];t&&(i.push(t),u.push(r))}));else{var c=function(e){for(var n,t=e.flatGraphUnits,a=e.values,i=e.collectWatches,u=[],f=[],c={},s=new Set,l=Object.getOwnPropertyNames(a),p=r(t);!(n=p()).done;){var d=n.value,m=d.reg,g=d.meta,y=g.op,b=g.sid;if(g.unit===k&&b&&_e(l,b)){var x=d.scope.state;x.current=a[b],s.add(x)}if(i&&'watch'===y){var S=d.family.owners[0];S.meta.unit===k&&(u.push(d),f.push(S.scope.state))}for(var q in m)c[q]=m[q]}return o(h(v(c)),(function(e){(function(e){var n=0;if(e.before&&!s.has(e))for(var t,a=r(e.before);!(t=a()).done;){var o=t.value;switch(o.type){case w:e.current=o.fn(o.from.current);break;case'field':var i=o.from;n||(n=1,e.current=Array.isArray(e.current)?[].concat(e.current):Object.assign({},e.current)),e.current[o.field]=i.current}}if(e.after)for(var u,f=e.current,c=r(e.after);!(u=c()).done;){var l=u.value,p=l.to;switch(l.type){case'copy':p.current=f;break;case w:p.current=l.fn(f)}}})(c[e])})),{storeWatches:u,storeWatchesRefs:f}}({flatGraphUnits:g(e),values:f,collectWatches:1});i=c.storeWatches,u=c.storeWatchesRefs.map((function(e){return e.current}))}Pe({target:i,params:u,forkPage:a?e:0})},exports.is=C,exports.launch=Pe,exports.merge=function(e,r){var n=f(r||t(e,'merge'));return Qe({from:e,to:n,meta:{op:'merge'}}),n},exports.restore=function(e,r,n){if(N(e))return e;if(S(e)){var t,a=ce(e);return A(e)&&(t=c(r,{parent:a,name:e.shortName,"ɔ":n}).on(e,(function(e,r){return r}))),j(e)&&(t=c(r,{parent:a,name:e.shortName,"ɔ":n}).on(e.done,(function(e,r){return r.result}))),a&&a.hooks.store(t),t}var o=Array.isArray(e)?[]:{};return Fe(e,(function(e,r){o[r]=N(e)?e:c(e,{name:r})})),o},exports.sample=d,exports.scopeBind=function(e){ye||P('scopeBind cannot be called outside of forked .watch');var r=ye.find(e),n=ye;return function(e){Pe({target:r,params:e,forkPage:n})}},exports.serialize=function(e,n){var t=e.clones,a=e.getState,o=e.cloneOf,i=void 0===n?{}:n,u=i.ignore,f=void 0===u?[]:u,c={};if(i.onlyChanges){f=[].concat(f);for(var s,l=r(o.history.stores);!(s=l()).done;){var p=s.value;a(p)===p.defaultState&&f.push(p)}}for(var d,v=r(t);!(d=v()).done;){var m=d.value,h=m.meta;if(h.unit===k){var g=h.sid;g&&(c[g]=m.reg[m.scope.state.id].current)}}for(var y,b=r(f);!(y=b()).done;){var w=y.value.sid;w&&delete c[w]}return c},exports.setStoreName=function(e,r){var n=a(r,ce(e));if(e.shortName=r,e.compositeName){var t=e.compositeName;t.path=n.path,t.shortName=n.shortName,t.fullName=n.fullName}else e.compositeName=n},exports.split=function(){for(var e,r=arguments.length,n=new Array(r),t=0;t<r;t++)n[t]=arguments[t];var a=Ee(n),o=a[0],i=o[0],u=o[1],f=a[1],c=!u;c&&(e=i.cases,u=i.match,i=i.source);var s={},l=N(i)?i.updates:i;if(Fe(u,(function(e,r){s[r]=l.filter({fn:e,config:f}),l=l.filter({fn:function(r){return!e(r)},config:f})})),s.__=l,!c)return s;Fe(s,(function(r,n){e[n]&&Qe({from:r,to:e[n]})}))},exports.step=Q,exports.version="21.7.5",exports.withFactory=function(e){var r=e.name,t=e.loc,a=e.method,o=e.fn;return i(n({meta:{sidRoot:Ke(e.sid),name:r,loc:t,method:a}}),o)},exports.withRegion=i;
//# sourceMappingURL=compat.js.map
