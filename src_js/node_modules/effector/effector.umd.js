((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e='undefined'!=typeof globalThis?globalThis:e||self).effector={})})(this,(e=>{function t({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:l=n||o,scope:s={},meta:i={},family:f={type:'regular'}}={}){let c=ve(a),u=ve(f.links),p=ve(f.owners),d=[],m={};for(let t=0;t<e.length;t++){let r=e[t];r&&(d.push(r),Se(r,m))}let h={id:J(),seq:d,next:ve(l),meta:i,scope:s,family:{type:f.type||q,links:u,owners:p},reg:m};for(let e=0;e<u.length;e++)ue(u[e]).push(h);for(let e=0;e<p.length;e++)pe(p[e]).push(h);for(let e=0;e<c.length;e++)c[e].next.push(h);return h}function r(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=O(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function a(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function n(e,t){e.forEach(t)}function o(e,t){let r=ce(e).meta;Ze={parent:Ze,value:e,template:r.template||et(),sidRoot:r.sidRoot||Ze&&Ze.sidRoot};try{return t()}finally{Ze=be(Ze)}}function l(e,r){let a=(e,...t)=>Ee?((e,t,r,a)=>{let n=Ee,o=null;if(t)for(o=Ee;o&&o.template!==t;)o=be(o);Ie(o);let l=e.create(r,a);return Ie(n),l})(a,n,e,t):a.create(e,t);a.graphite=t({meta:ft(k,a,r,e)}),a.create=e=>{let t=Oe?Oe.find(a):a;return ze(t,e),e},a.watch=K(nt,a),a.map=e=>{let t,r;W(e)&&(t=e,r=e.name,e=e.fn);let n=l($e(a,r),t);return ut(a,n,x,e),n},a.filter=e=>pt(a,D,e.fn?e:e.fn,[te({fn:fe})]),a.filterMap=e=>pt(a,'filterMap',e,[ee({fn:fe}),Z.defined()]),a.prepend=e=>{let t=l('* → '+a.shortName,{parent:be(a)}),r=et();return r&&ce(t).seq.push(r.upward),ut(t,a,'prepend',e),st(a,t),t};let n=et();return Ye(a)}function s(e,r){function a(e,t){c.off(e),ye(c).set(e,Xe(dt(e,c,'on',1,t)))}let n=oe(e),o=oe(e),l=ct('updates'),i=et();n.after=[{type:'copy',to:o}],i&&i.plain.push(n,o);let f=n.id,c={subscribers:new Map,updates:l,defaultState:e,stateRef:n,getState(){let e,t=n;if(Ee){let t=Ee;for(;t&&!t.reg[f];)t=be(t);t&&(e=t)}return!e&&Oe&&Oe.reg[f]&&(e=Oe),e&&(t=e.reg[f]),le(t)},setState(e){let t;Oe&&(t=Oe.nodeMap[ce(c).id]),t||(t=c),ze({target:t,params:e,defer:1})},reset(...e){for(let t of e)c.on(t,(()=>c.defaultState));return c},on(e,t){if(Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return c},off(e){let t=ye(c).get(e);return t&&(t(),ye(c).delete(e)),c},map(e,t){let r,a,o;W(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let l=c.getState(),i=et();i?o=null:void 0!==l&&(o=e(l,t));let f=s(o,{name:$e(c,a),config:r,strict:0}),u=dt(c,f,x,0,e);return de(f).before=[{type:x,fn:e,from:n}],i&&(Ue(i.plain,n)||Ue(u.seq,i.loader)||u.seq.unshift(i.loader)),f},watch(e,t){if(!t||!O(e)){let t=nt(c,e),r=et();return r?r.watch.push({of:n,fn:e}):e(c.getState()),t}return $(t)||T('second argument should be a function'),e.watch((e=>t(c.getState(),e)))}};return c.graphite=t({scope:{state:n},node:[Z.defined(),ae({store:n}),Z.changed({store:o}),ae({store:o})],child:l,meta:ft(b,c,r)}),lt&&void 0===e&&T("current state can't be undefined, use null instead"),we(c,[l]),Ye(c)}function i(...e){let t,r,a;He(e[0],((t,r)=>{a=t,e=r}));let n,o,l=e[e.length-1];if($(l)?(r=e.slice(0,-1),t=l):r=e,1===r.length){let e=r[0];_(e)||(n=e,o=1)}return o||(n=r,t&&(t=mt(t))),W(n)||T('shape should be an object'),ht(Array.isArray(n),n,a,t)}function f(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function c(e,r){let a=l(e,r),n=a.defaultConfig.handler||(()=>T("no handler used in "+a.getType())),o=ce(a);o.meta.onCopy=['runner'],o.meta.unit=a.kind=w,a.use=e=>($(e)||T('.use argument should be a function'),n=e,a);let i=a.finally=ct('finally'),c=a.done=i.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),u=a.fail=i.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),p=a.doneData=c.map({named:'doneData',fn:({result:e})=>e}),d=a.failData=u.map({named:'failData',fn:({error:e})=>e}),m=t({scope:{getHandler:a.use.getCurrent=()=>n,finally:i},node:[re({fn({params:e,req:t},{finally:r,getHandler:a},n){let o,l=gt({params:e,req:t,ok:1,anyway:r,stack:n}),s=gt({params:e,req:t,ok:0,anyway:r,stack:n});try{o=a()(e)}catch(e){return void s(e)}W(o)&&$(o.then)?o.then(l,s):l(o)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});o.scope.runner=m,o.seq.push(ee({fn:(e,t,r)=>be(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),re({fn:(e,{runner:t},r)=>(ze({target:t,params:e,defer:1,forkPage:ke(r)}),e.params)})),a.create=e=>{let t=f(),r={params:e,req:t};if(Oe){if(!_e){let e=Oe;t.req.finally((()=>{Fe(e)}))}ze(Oe.find(a),r)}else ze(a,r);return t.req};let h=a.inFlight=s(0,{named:'inFlight'}).on(a,(e=>e+1)).on(i,(e=>e-1)),g=a.pending=h.map({fn:e=>e>0,named:'pending'});return we(a,[i,c,u,p,d,g,h,m]),a}function u(...e){let r,a,n,o,[[f,c,u],p]=Be(e);void 0===c&&'source'in f&&('clock'in f&&null==f.clock&&T('config.clock should be defined'),c=f.clock,u=f.fn,o=f.greedy,r=f.target,a=f.name,n=f.sid,f=f.source),O(f)||(f=i(f)),void 0===c&&(c=f),a=p||a||f.shortName;let d=et(),m=!!r;r||(_(f)&&_(c)?r=s(u?u(le(de(f)),le(de(c))):le(de(f)),{name:a,sid:n}):(r=l(a),d&&ce(r).seq.push(d.loader)));let h=m&&O(r)&&ce(r).meta.nativeTemplate;if(_(f)){let e=de(f);we(f,[rt(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,!o&&X({priority:S}),Y({store:e,to:u?C:N}),u&&ee({fn:ie}),d&&m&&d.upward],meta:{op:R,sample:b}})]),d&&(Ue(d.plain,e)||Ue(d.closure,e)||d.closure.push(e))}else{let e=oe(0),a=oe(),n=oe();d&&d.plain.push(e,a,n),Ye(t({parent:f,node:[ae({store:a}),Y({from:A,store:1,target:e})],family:{owners:[f,r,c],links:r},meta:{op:R,sample:'source'}})),we(f,[rt(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,ae({store:n}),Y({store:e}),te({fn:e=>e}),!o&&X({priority:S}),Y({store:a}),Y({store:n,to:C}),u&&ee({fn:se}),d&&m&&d.upward],meta:{op:R,sample:'clock'}})])}return r}function p(e){let t=Object.values(e),r={};for(let{id:e}of t)r[e]=[];for(let{id:e,before:a,after:o}of t)a&&n(a,(t=>{r[t.from.id].push(e)})),o&&n(o,(t=>{r[e].push(t.to.id)}));return r}function d(e){if(e instanceof Map){let t={};for(let[r,a]of e)O(r)||T('Map key should be a unit'),t[r.sid]=a;return t}return e}function m(e,t){function r(e){s[e]=1;let t=a[e];for(let e=0;e<t.length;e++){let a=t[e];s[a]||l[a]||r(a)}s[e]=0,l[e]=1,o.push(e)}let a={};for(let t in e)a[t]=[...new Set(e[t])];let o=[],l={},s={};for(let e in a)l[e]||s[e]||r(e);if(o.reverse(),t&&t.size>0){let e,r=[],l=[...t];for(;e=l.shift();)r.push(e),n(a[e],(e=>{Ue(r,e)||Ue(l,e)||l.push(e)}));n(r,(e=>{Je(o,e)}))}return o}function h(e){let t=[];return function e(r){Ue(t,r)||(t.push(r),g(r,e))}(ce(e)),t}function g(e,t){let r=e.meta.unit;'fork'!==r&&r!==P&&(n(e.next,t),n(ue(e),t),n(pe(e),t))}let y='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',b='store',k='event',w='effect',v='domain',S='sampler',q='crosslink',x='map',N='stack',j='barrier',A='value',P='forkInFlightCounter',R='sample',D='filter',C='a',O=e=>($(e)||W(e))&&'kind'in e;const M=e=>t=>O(t)&&t.kind===e;let _=M(b),E=M(k),F=M(w),I=M(v);var z={__proto__:null,unit:O,store:_,event:E,effect:F,domain:I};let T=e=>{throw Error(e)},W=e=>'object'==typeof e&&null!==e,$=e=>'function'==typeof e,H=e=>{W(e)||$(e)||T('expect first argument be an object')};const B=()=>{let e=0;return()=>(++e).toString(36)};let G=B(),U=B(),J=B(),K=(e,t)=>e.bind(null,t),L=(e,t,r)=>e.bind(null,t,r);const Q=(e,t,r)=>({id:U(),type:e,data:r,hasRef:t});let V=0,X=({priority:e=j})=>Q(j,0,{barrierID:++V,priority:e}),Y=({from:e=b,store:t,target:r,to:a=(r?b:N)})=>Q('mov',e===b,{from:e,store:t,to:a,target:r}),Z={defined:()=>Q('check',0,{type:'defined'}),changed:({store:e})=>Q('check',1,{type:'changed',store:e})},ee=L(Q,'compute',0),te=L(Q,D,0),re=L(Q,'run',0),ae=({store:e})=>Y({from:N,target:e});var ne={__proto__:null,barrier:X,mov:Y,check:Z,compute:ee,filter:te,run:re,update:ae};let oe=e=>({id:U(),current:e}),le=({current:e})=>e,se=(e,{fn:t},{a:r})=>t(e,r),ie=(e,{fn:t},{a:r})=>t(r,e),fe=(e,{fn:t})=>t(e),ce=e=>e.graphite||e,ue=e=>e.family.owners,pe=e=>e.family.links,de=e=>e.stateRef,me=e=>e.config,he=e=>e.ɔ,ge=e=>e.value,ye=e=>e.subscribers,be=e=>e.parent,ke=e=>e.forkPage,we=(e,t)=>{let r=ce(e);for(let e=0;e<t.length;e++){let a=ce(t[e]);r.family.type!==v&&(a.family.type=q),ue(a).push(r),pe(r).push(a)}};const ve=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(ce)};let Se=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&r.to===b&&(n=r.target,a[n.id]=n)},qe=null;const xe=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&e.v.type===S)&&(r=e,e=t,t=r),r=xe(e.r,t),e.r=e.l,e.l=r,e},Ne=[];let je=0;for(;je<5;)Ne.push({first:null,last:null,size:0}),je+=1;const Ae=()=>{for(let e=0;e<5;e++){let t=Ne[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=qe.v;return qe=xe(qe.l,qe.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Pe=(e,t,r,a,n,o)=>Re(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),Re=(e,t,r,a=0)=>{let n=De(r),o=Ne[n],l={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?qe=xe(qe,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},De=e=>{switch(e){case'child':return 0;case'pure':return 1;case j:return 2;case S:return 3;case w:return 4;default:return-1}},Ce=new Set;let Oe,Me=1,_e=0,Ee=null,Fe=e=>{Oe=e},Ie=e=>{Ee=e},ze=(e,t,r)=>{let a=Ee,n=null,o=Oe;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=ke(e)||o,e=e.target),Array.isArray(e))for(let r=0;r<e.length;r++)Pe('pure',a,ce(e[r]),n,t[r],o);else Pe('pure',a,ce(e),n,t,o);r&&!Me||(()=>{let e,t,r,a,n,o,l={isRoot:Me,currentPage:Ee,forkPage:Oe,isWatch:_e};Me=0;e:for(;a=Ae();){let{idx:s,stack:i,type:f}=a;r=i.node,Ee=n=i.page,Oe=ke(i),o=(n||r).reg;let c={fail:0,scope:r.scope};e=t=0;for(let a=s;a<r.seq.length&&!e;a++){let u=r.seq[a],p=u.data;switch(u.type){case j:{let e=p.barrierID;n&&(e=`${n.fullID}_${e}`);let t=p.priority;if(a!==s||f!==t){Ce.has(e)||(Ce.add(e),Re(a,i,t,e));continue e}Ce.delete(e);break}case'mov':{let e;switch(p.from){case N:e=ge(i);break;case C:case'b':e=i[p.from];break;case A:e=p.store;break;case b:o[p.store.id]||(i.page=n=null,o=r.reg),e=le(o[p.store.id])}switch(p.to){case N:i.value=e;break;case C:case'b':i[p.to]=e;break;case b:o[p.target.id].current=e}break}case'check':switch(p.type){case'defined':t=void 0===ge(i);break;case'changed':t=ge(i)===le(o[p.store.id])}break;case D:t=!Te(c,p,i);break;case'run':if(a!==s||f!==w){Re(a,i,w);continue e}case'compute':_e='watch'===r.meta.op,i.value=Te(c,p,i),_e=l.isWatch}e=c.fail||t}if(!e)for(let e=0;e<r.next.length;e++)Pe('child',n,r.next[e],i,ge(i),ke(i))}Me=l.isRoot,Ee=l.currentPage,Oe=ke(l)})()};const Te=(e,{fn:t},r)=>{try{return t(ge(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let We=(e,t)=>''+e.shortName+t,$e=(e,t)=>null==t?We(e,' → *'):t,He=(e,t)=>{H(e),he(e)&&t(me(e),he(e))},Be=e=>{let t;return He(e[0],((r,a)=>{t=r,e=a})),[e,t]},Ge=(e,t)=>{for(let r in e)t(e[r],r)},Ue=(e,t)=>e.includes(t),Je=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const Ke=(e,t)=>{Je(e.next,t),Je(ue(e),t),Je(pe(e),t)},Le=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=pe(e);for(;a=n.pop();)Ke(a,e),(t||r&&!e.meta.sample||a.family.type===q)&&Le(a,t,'on'!==a.meta.op&&r);for(n=ue(e);a=n.pop();)Ke(a,e),r&&a.family.type===q&&Le(a,t,'on'!==a.meta.op&&r)},Qe=e=>e.clear();let Ve=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),_(e))Qe(ye(e));else if(I(e)){r=1;let t=e.history;Qe(t.events),Qe(t.effects),Qe(t.stores),Qe(t.domains)}Le(ce(e),!!t,r)},Xe=e=>{let t=L(Ve,e,void 0);return t.unsubscribe=t,t},Ye=e=>(Ze&&we(ge(Ze),[e]),e),Ze=null,et=()=>Ze&&Ze.template,tt=e=>(e&&Ze&&Ze.sidRoot&&(e=`${Ze.sidRoot}ɔ${e}`),e),rt=(e,r,{node:a,scope:n,meta:o})=>Ye(t({node:a,parent:e,child:r,scope:n,meta:o,family:{owners:[e,r],links:r}})),at=e=>{let r;He(e,((t,a)=>{r=t,e=a}));let{from:a,to:n,meta:o={op:'forward'}}=e;return a&&n||T('from and to fields should be defined'),r&&(o.config=r),Xe(Ye(t({parent:a,child:n,meta:o,family:{}})))},nt=(e,r)=>{if($(r)||T('.watch argument should be a function'),Oe){let t=Oe.nodeMap[ce(e).id];t&&(e=t)}return Xe(Ye(t({scope:{fn:r},node:[re({fn:fe})],parent:e,meta:{op:'watch'},family:{owners:e}})))};const ot=(e,t)=>(W(e)&&(ot(me(e),t),null!=e.name&&(W(e.name)?ot(e.name,t):$(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),be(e)&&(t.parent=be(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),ot(he(e),t)),t);let lt,st=(e,t,r=k)=>{be(e)&&be(e).hooks[r](t)},ft=(e,t,r,n)=>{let o=ot({name:n,config:r},{}),l=e===v,s=G(),{parent:i=null,sid:f=null,strict:c=1,named:u=null}=o,p=u||o.name||(l?'':s),d=a(p,i),m={unit:t.kind=e,name:t.shortName=p,sid:t.sid=tt(f),named:u,unitId:t.id=s};if(t.parent=i,t.compositeName=d,t.defaultConfig=o,t.thru=e=>e(t),t.getType=()=>d.fullName,!l){t.subscribe=e=>(H(e),t.watch($(e)?e:t=>{e.next&&e.next(t)})),t[y]=()=>t;let e=et();e&&(m.nativeTemplate=e)}return lt=c,m},ct=e=>l({named:e});const ut=(e,t,r,a)=>rt(e,t,{scope:{fn:a},node:[ee({fn:fe})],meta:{op:r}}),pt=(e,t,r,a)=>{let n;W(r)&&(n=r,r=r.fn);let o=l(We(e,' →? *'),n);return rt(e,o,{scope:{fn:r},node:a,meta:{op:t}}),o},dt=(e,t,r,a,n)=>{let o=de(t),l=[Y({store:o,to:C}),ee({fn:a?ie:se}),Z.defined(),Z.changed({store:o}),ae({store:o})],s=et();if(s&&(l.unshift(s.loader),l.push(s.upward),_(e))){let t=de(e);Ue(s.plain,t)||(Ue(s.closure,t)||s.closure.push(t),o.before||(o.before=[]),o.before.push({type:'closure',of:t}))}return rt(e,t,{scope:{fn:n},node:l,meta:{op:r}})},mt=e=>t=>e(...t),ht=(e,t,a,n)=>{let o=e?e=>e.slice():e=>({...e}),l=e?[]:{},i=et(),f=o(l),c=oe(f),u=oe(1);c.type=e?'list':'shape',i&&i.plain.push(c,u);let p=s(f,{name:a||r(t)}),d=[Z.defined(),Y({store:c,to:C}),te({fn:(e,{key:t},{a:r})=>e!==r[t]}),Y({store:u,to:'b'}),ee({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),Y({from:C,target:c}),Y({from:A,store:0,target:u}),X({priority:j}),Y({from:A,store:1,target:u}),Y({store:c}),n&&ee({fn:n}),Z.changed({store:de(p)})],m=c.before=[];return Ge(t,((e,t)=>{if(!_(e))return void(f[t]=l[t]=e);l[t]=e.defaultState,f[t]=e.getState();let r=rt(e,p,{scope:{key:t,clone:o},node:d,meta:{op:'combine'}}),a=de(e);m.push({type:'field',field:t,from:a}),i&&(Ue(i.plain,a)||r.seq.unshift(i.loader))})),p.defaultShape=t,c.after=[n?{type:x,to:de(p),fn:n}:{type:'copy',to:de(p)}],i||(p.defaultState=n?de(p).current=n(f):l),p};let gt=({params:e,req:t,ok:r,anyway:a,stack:n})=>o=>ze({target:[a,yt],params:[r?{status:'done',params:e,result:o}:{status:'fail',params:e,error:o},{fn:r?t.rs:t.rj,value:o}],defer:1,page:n.page,forkPage:ke(n)});const yt=t({node:[re({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}}),bt=(e,t,r)=>(e.watch((e=>{we(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),be(e)||(e.parent=r)})),we(r,[e]),r=>(t.forEach(r),e.watch(r)));e.allSettled=(e,{scope:t,params:r})=>{if(!O(e))return Promise.reject(Error('first argument should be unit'));let a=f();a.parentFork=Oe;let{forkInFlightCounter:n}=t.graphite.scope;n.scope.defers.push(a);let o=[t.find(e)],l=[];return F(e)?l.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):l.push(r),o.push(n),l.push(null),ze({target:o,params:l,forkPage:t}),a.req},e.attach=e=>{let t;He(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:n}=e;n||(n=r?(e,t)=>t:e=>e);let o,l=c(e,t),{runner:s}=ce(l).scope,f=({params:e,req:t},{finally:r,effect:a},o)=>{let l,s=gt({params:e,req:t,ok:0,anyway:r,stack:o});try{l=n(e,o.a)}catch(e){return s(e)}ze({target:a,params:{params:l,req:{rs:gt({params:e,req:t,ok:1,anyway:r,stack:o}),rj:s}},page:o.page,defer:1})};if(r){let e;_(r)?e=r:(e=i(r),we(l,[e]));let t=Y({from:b,store:de(e),to:C});o=[re({fn:e=>e}),t,ee({fn:f})],Se(t,s.reg)}else o=[re({fn:f})];return s.scope.effect=a,s.meta.onCopy.push(w),s.seq.splice(0,1,...o),st(a,l,w),l},e.clearNode=Ve,e.combine=i,e.createApi=(...e)=>{let[[t,r],a]=Be(e),n={};return Ge(r,((e,r)=>{let o=n[r]=l(r,{parent:be(t),config:a});t.on(o,e),st(t,o)})),n},e.createDomain=function e(r,a){let n=new Set,o=new Set,i=new Set,f=new Set,u=t({family:{type:v}}),p={history:{domains:n,stores:o,effects:i,events:f},graphite:u};u.meta=ft(v,p,a,r);let[d,m,h,g]=['onEvent','onEffect','onStore','onDomain'].map(ct);p.hooks={event:d,effect:m,store:h,domain:g},p.onCreateEvent=bt(d,f,p),p.onCreateEffect=bt(m,i,p),p.onCreateStore=bt(h,o,p),p.onCreateDomain=bt(g,n,p),p.createEvent=p.event=(e,t)=>d(l(e,{parent:p,config:t})),p.createEffect=p.effect=(e,t)=>m(c(e,{parent:p,config:t})),p.createDomain=p.domain=(t,r)=>e({name:t,parent:p,config:r}),p.createStore=p.store=(e,t)=>h(s(e,{parent:p,config:t})),Ye(p);let y=be(p);return y&&(Ge(p.hooks,((e,t)=>{at({from:e,to:y.hooks[t]})})),y.hooks.domain(p)),p},e.createEffect=c,e.createEvent=l,e.createNode=t,e.createStore=s,e.createStoreObject=i,e.fork=(e,{values:r,handlers:a}={})=>{I(e)||T('first argument of fork should be domain');let o=!!r;r=d(r||{});let l=(e=>{function r(e){let t=ce(e),r=a.indexOf(t);if(-1===r){let r='unit';e!==t&&e.id!==e.shortName&&(r=e.shortName),T(r+" not found in forked scope")}return c[r]}let a=h(e),o=new Map,l=ee({fn:(e,t,r)=>(Fe(ke(r)),e)}),s=t({scope:{defers:[],inFlight:0,fxID:0},node:[ee({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),X({priority:S}),re({fn(e,t){let{inFlight:r,defers:a,fxID:o}=t;r>0||0===a.length||Promise.resolve().then((()=>{t.fxID===o&&n(a.splice(0,a.length),(e=>{Fe(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:P}}),i={},f={},c=a.map((e=>{let{seq:r,next:a,meta:n,scope:o}=e,l=t({node:r.map((e=>({id:e.id,type:e.type,data:{...e.data},hasRef:e.hasRef}))),child:[...a],meta:{forkOf:e,...n},scope:{...o}});return l.family={type:e.family.type,links:[...pe(e)],owners:[...ue(e)]},i[e.id]=l,n.sid&&(f[n.sid]=l),l})),u={};return n(c,(e=>{let{reg:t,scope:a,meta:{onCopy:n,op:i,unit:f}}=e;for(let e in t){let r=t[e],a=o.get(r);a||(a={id:r.id,current:r.current},o.set(r,a)),u[e]=t[e]=a}if(n)for(let e=0;e<n.length;e++)a[n[e]]=r(a[n[e]]);switch(g(e,((e,t,a)=>{a[t]=r(e)})),i||f){case b:e.meta.wrapped=(e=>({kind:b,getState:()=>e.reg[e.scope.state.id].current,updates:{watch:K(nt,e)},graphite:e,family:e.family}))(e);break;case k:e.seq.unshift(l);break;case w:e.next.push(s),e.seq.unshift(l);break;case'fx':a.finally.next.push(s),e.seq.unshift(l);break;case'watch':e.seq.unshift(l)}})),{cloneOf:e,nodeMap:i,sidMap:f,clones:c,find:r,reg:u,getState:e=>r(e).meta.wrapped.getState(),graphite:t({family:{type:v,links:[s,...c]},meta:{unit:'fork'},scope:{forkInFlightCounter:s}})}})(e);if(o&&(()=>{let t=h(e),a={},o={},s=new Set,i=new Set,f=Object.getOwnPropertyNames(r);for(let{reg:e,meta:r}of t){let{nativeTemplate:t}=r;for(let r in e)a[r]=e[r],t&&i.add(r)}for(let e of l.clones){let{reg:t}=e,{unit:a,sid:n}=e.meta;if(a===b&&n&&Ue(f,n)){let{state:a}=e.scope;t[a.id].current=r[n],s.add(a)}for(let e in t)o[e]=t[e]}n(m(p(a),i),(e=>{((e,t)=>{let r=0;if(t&&t.before&&!s.has(e))for(let a of t.before)switch(a.type){case x:e.current=a.fn(o[a.from.id].current);break;case'field':{let t=o[a.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[a.field]=t.current;break}}if(!t||!t.after)return;let a=e.current;for(let e of t.after){let t=o[e.to.id];switch(e.type){case'copy':t.current=a;break;case x:t.current=e.fn(a)}}})(o[e],a[e])}))})(),a){a=d(a);let e=Object.keys(a);for(let{scope:t,meta:r}of l.clones)r.sid&&Ue(e,r.sid)&&(t.runner.scope.getHandler=()=>a[r.sid])}return l},e.forward=at,e.fromObservable=e=>{H(e);let t=y in e?e[y]():e;t.subscribe||T('expect observable to have .subscribe');let r=l(),a=L(Ve,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r},e.guard=(...e)=>{let r={op:'guard'},a='guard',[[n,o],s]=Be(e);s&&(r.config=s,s.name&&(a=s.name)),o||(o=n,n=o.source);let{filter:f,greedy:c,name:p=a}=o,d=o.target||l(p,r.config);return O(n)||(n=i(n)),O(f)?u({source:f,clock:n,target:Ye(t({node:[te({fn:({guard:e})=>e}),ee({fn:({data:e})=>e})],child:d,meta:r,family:{owners:[n,f,d],links:d}})),fn:(e,t)=>({guard:e,data:t}),greedy:c,name:p}):($(f)||T('`filter` should be function or unit'),rt(n,d,{scope:{fn:f},node:[te({fn:fe})],meta:r})),d},e.hydrate=(e,{values:t})=>{let r=W(e)&&e.cloneOf;I(e)||r||T('first argument of hydrate should be domain or scope'),W(t)||T('values property should be an object');let a,o,l=d(t);if(r)a=[],o=[],Ge(l,((t,r)=>{let n=e.sidMap[r];n&&(a.push(n),o.push(t))}));else{let t=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let a=[],o=[],l={},s=new Set,i=Object.getOwnPropertyNames(t);for(let n of e){let{reg:e}=n,{op:f,unit:c,sid:u}=n.meta;if(c===b&&u&&Ue(i,u)){let{state:e}=n.scope;e.current=t[u],s.add(e)}if(r&&'watch'===f){let e=n.family.owners[0];e.meta.unit===b&&(a.push(n),o.push(e.scope.state))}for(let t in e)l[t]=e[t]}return n(m(p(l)),(e=>{(e=>{let t=0;if(e.before&&!s.has(e))for(let r of e.before)switch(r.type){case x:e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}if(!e.after)return;let r=e.current;for(let t of e.after){let e=t.to;switch(t.type){case'copy':e.current=r;break;case x:e.current=t.fn(r)}}})(l[e])})),{storeWatches:a,storeWatchesRefs:o}})({flatGraphUnits:h(e),values:l,collectWatches:1});a=t.storeWatches,o=t.storeWatchesRefs.map((({current:e})=>e))}ze({target:a,params:o,forkPage:r?e:0})},e.is=z,e.launch=ze,e.merge=(e,t)=>{let a=l(t||r(e,'merge'));return at({from:e,to:a,meta:{op:'merge'}}),a},e.restore=(e,t,r)=>{if(_(e))return e;if(O(e)){let a,n=be(e);return E(e)&&(a=s(t,{parent:n,name:e.shortName,ɔ:r}).on(e,((e,t)=>t))),F(e)&&(a=s(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,((e,{result:t})=>t))),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return Ge(e,((e,t)=>{a[t]=_(e)?e:s(e,{name:t})})),a},e.sample=u,e.scopeBind=e=>{Oe||T('scopeBind cannot be called outside of forked .watch');let t=Oe.find(e),r=Oe;return e=>{ze({target:t,params:e,forkPage:r})}},e.serialize=({clones:e,getState:t,cloneOf:r},{ignore:a=[],onlyChanges:n}={})=>{let o={};if(n){a=[...a];for(let e of r.history.stores)t(e)===e.defaultState&&a.push(e)}for(let{meta:t,scope:r,reg:a}of e){if(t.unit!==b)continue;let{sid:e}=t;e&&(o[e]=a[r.state.id].current)}for(let{sid:e}of a)e&&delete o[e];return o},e.setStoreName=(e,t)=>{let r=a(t,be(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=r);let n=e.compositeName;n.path=r.path,n.shortName=r.shortName,n.fullName=r.fullName},e.split=(...e)=>{let t,[[r,a],n]=Be(e),o=!a;o&&(t=r.cases,a=r.match,r=r.source);let l={},s=_(r)?r.updates:r;if(Ge(a,((e,t)=>{l[t]=s.filter({fn:e,config:n}),s=s.filter({fn:t=>!e(t),config:n})})),l.__=s,!o)return l;Ge(l,((e,r)=>{t[r]&&at({from:e,to:t[r]})}))},e.step=ne,e.version="21.7.5",e.withFactory=({sid:e,name:r,loc:a,method:n,fn:l})=>o(t({meta:{sidRoot:tt(e),name:r,loc:a,method:n}}),l),e.withRegion=o,Object.defineProperty(e,'__esModule',{value:1})}));
//# sourceMappingURL=effector.umd.js.map
