function e({node:e=[],from:t,source:r,parent:a=t||r,to:n,target:o,child:s=n||o,scope:l={},meta:i={},family:f={type:'regular'}}={}){let c=ie(a),u=ie(f.links),p=ie(f.owners),d=[],m={};for(let t=0;t<e.length;t++){let r=e[t];r&&(d.push(r),fe(r,m))}let h={id:M(),seq:d,next:ie(s),meta:i,scope:l,family:{type:f.type||"crosslink",links:u,owners:p},reg:m};for(let e=0;e<u.length;e++)Y(u[e]).push(h);for(let e=0;e<p.length;e++)Z(p[e]).push(h);for(let e=0;e<c.length;e++)c[e].next.push(h);return h}function t(e,t="combine"){let r=t+'(',a='',n=0;for(let t in e){let o=e[t];if(null!=o&&(r+=a,r+=b(o)?o.compositeName.fullName:o.toString()),n+=1,25===n)break;a=', '}return r+=')',r}function r(e,t){let r,a,n,o=e;return t?(n=t.compositeName,0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)):(r=0===e.length?[]:[e],a=e),{shortName:o,fullName:a,path:r}}function a(e,t){e.forEach(t)}function n(e,t){let r=X(e).meta;Te={parent:Te,value:e,template:r.template||$e(),sidRoot:r.sidRoot||Te&&Te.sidRoot};try{return t()}finally{Te=oe(Te)}}function o(t,r){let a=(e,...t)=>xe?((e,t,r,a)=>{let n=xe,o=null;if(t)for(o=xe;o&&o.template!==t;)o=oe(o);qe(o);let s=e.create(r,a);return qe(n),s})(a,n,e,t):a.create(e,t);a.graphite=e({meta:Qe("event",a,r,t)}),a.create=e=>{let t=be?be.find(a):a;return Ne(t,e),e},a.watch=F(Ue,a),a.map=e=>{let t,r;P(e)&&(t=e,r=e.name,e=e.fn);let n=o(Re(a,r),t);return Xe(a,n,k,e),n},a.filter=e=>Ye(a,"filter",e.fn?e:e.fn,[H({fn:V})]),a.filterMap=e=>Ye(a,'filterMap',e,[$({fn:V}),T.defined()]),a.prepend=e=>{let t=o('* → '+a.shortName,{parent:oe(a)}),r=$e();return r&&X(t).seq.push(r.upward),Xe(t,a,'prepend',e),Le(a,t),t};let n=$e();return We(a)}function s(t,r){function a(e,t){c.off(e),ne(c).set(e,ze(Ze(e,c,'on',1,t)))}let n=J(t),o=J(t),l=Ve('updates'),i=$e();n.after=[{type:'copy',to:o}],i&&i.plain.push(n,o);let f=n.id,c={subscribers:new Map,updates:l,defaultState:t,stateRef:n,getState(){let e,t=n;if(xe){let t=xe;for(;t&&!t.reg[f];)t=oe(t);t&&(e=t)}return!e&&be&&be.reg[f]&&(e=be),e&&(t=e.reg[f]),K(t)},setState(e){let t;be&&(t=be.nodeMap[X(c).id]),t||(t=c),Ne({target:t,params:e,defer:1})},reset(...e){for(let t of e)c.on(t,(()=>c.defaultState));return c},on(e,t){if(Array.isArray(e))for(let r of e)a(r,t);else a(e,t);return c},off(e){let t=ne(c).get(e);return t&&(t(),ne(c).delete(e)),c},map(e,t){let r,a,o;P(e)&&(r=e,a=e.name,t=e.firstState,e=e.fn);let l=c.getState(),i=$e();i?o=null:void 0!==l&&(o=e(l,t));let f=s(o,{name:Re(c,a),config:r,strict:0}),u=Ze(c,f,k,0,e);return ee(f).before=[{type:k,fn:e,from:n}],i&&(Oe(i.plain,n)||Oe(u.seq,i.loader)||u.seq.unshift(i.loader)),f},watch(e,t){if(!t||!b(e)){let t=Ue(c,e),r=$e();return r?r.watch.push({of:n,fn:e}):e(c.getState()),t}return R(t)||A('second argument should be a function'),e.watch((e=>t(c.getState(),e)))}};return c.graphite=e({scope:{state:n},node:[T.defined(),G({store:n}),T.changed({store:o}),G({store:o})],child:l,meta:Qe(y,c,r)}),Ke&&void 0===t&&A("current state can't be undefined, use null instead"),le(c,[l]),We(c)}function l(...e){let t,r,a;je(e[0],((t,r)=>{a=t,e=r}));let n,o,s=e[e.length-1];if(R(s)?(r=e.slice(0,-1),t=s):r=e,1===r.length){let e=r[0];w(e)||(n=e,o=1)}return o||(n=r,t&&(t=et(t))),P(n)||A('shape should be an object'),tt(Array.isArray(n),n,a,t)}function i(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function f(t,r){let a=o(t,r),n=a.defaultConfig.handler||(()=>A("no handler used in "+a.getType())),l=X(a);l.meta.onCopy=['runner'],l.meta.unit=a.kind="effect",a.use=e=>(R(e)||A('.use argument should be a function'),n=e,a);let f=a.finally=Ve('finally'),c=a.done=f.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),u=a.fail=f.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),p=a.doneData=c.map({named:'doneData',fn:({result:e})=>e}),d=a.failData=u.map({named:'failData',fn:({error:e})=>e}),m=e({scope:{getHandler:a.use.getCurrent=()=>n,finally:f},node:[B({fn({params:e,req:t},{finally:r,getHandler:a},n){let o,s=rt({params:e,req:t,ok:1,anyway:r,stack:n}),l=rt({params:e,req:t,ok:0,anyway:r,stack:n});try{o=a()(e)}catch(e){return void l(e)}P(o)&&R(o.then)?o.then(s,l):s(o)}})],meta:{op:'fx',fx:'runner',onCopy:['finally']}});l.scope.runner=m,l.seq.push($({fn:(e,t,r)=>oe(r)?{params:e,req:{rs(e){},rj(e){}}}:e}),B({fn:(e,{runner:t},r)=>(Ne({target:t,params:e,defer:1,forkPage:se(r)}),e.params)})),a.create=e=>{let t=i(),r={params:e,req:t};if(be){if(!we){let e=be;t.req.finally((()=>{Se(e)}))}Ne(be.find(a),r)}else Ne(a,r);return t.req};let h=a.inFlight=s(0,{named:'inFlight'}).on(a,(e=>e+1)).on(f,(e=>e-1)),g=a.pending=h.map({fn:e=>e>0,named:'pending'});return le(a,[f,c,u,p,d,g,h,m]),a}function c(...t){let r,a,n,i,[[f,c,u],p]=Ce(t);void 0===c&&'source'in f&&('clock'in f&&null==f.clock&&A('config.clock should be defined'),c=f.clock,u=f.fn,i=f.greedy,r=f.target,a=f.name,n=f.sid,f=f.source),b(f)||(f=l(f)),void 0===c&&(c=f),a=p||a||f.shortName;let d=$e(),m=!!r;r||(w(f)&&w(c)?r=s(u?u(K(ee(f)),K(ee(c))):K(ee(f)),{name:a,sid:n}):(r=o(a),d&&X(r).seq.push(d.loader)));let h=m&&b(r)&&X(r).meta.nativeTemplate;if(w(f)){let e=ee(f);le(f,[Be(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,!i&&z({priority:"sampler"}),W({store:e,to:u?"a":"stack"}),u&&$({fn:Q}),d&&m&&d.upward],meta:{op:"sample",sample:y}})]),d&&(Oe(d.plain,e)||Oe(d.closure,e)||d.closure.push(e))}else{let t=J(0),a=J(),n=J();d&&d.plain.push(t,a,n),We(e({parent:f,node:[G({store:a}),W({from:"value",store:1,target:t})],family:{owners:[f,r,c],links:r},meta:{op:"sample",sample:'source'}})),le(f,[Be(c,r,{scope:{fn:u,targetTemplate:h},node:[d&&d.loader,G({store:n}),W({store:t}),H({fn:e=>e}),!i&&z({priority:"sampler"}),W({store:a}),W({store:n,to:"a"}),u&&$({fn:L}),d&&m&&d.upward],meta:{op:"sample",sample:'clock'}})])}return r}function u(e){let t=Object.values(e),r={};for(let{id:e}of t)r[e]=[];for(let{id:e,before:n,after:o}of t)n&&a(n,(t=>{r[t.from.id].push(e)})),o&&a(o,(t=>{r[e].push(t.to.id)}));return r}function p(e){if(e instanceof Map){let t={};for(let[r,a]of e)b(r)||A('Map key should be a unit'),t[r.sid]=a;return t}return e}function d(e,t){function r(e){l[e]=1;let t=n[e];for(let e=0;e<t.length;e++){let a=t[e];l[a]||s[a]||r(a)}l[e]=0,s[e]=1,o.push(e)}let n={};for(let t in e)n[t]=[...new Set(e[t])];let o=[],s={},l={};for(let e in n)s[e]||l[e]||r(e);if(o.reverse(),t&&t.size>0){let e,r=[],s=[...t];for(;e=s.shift();)r.push(e),a(n[e],(e=>{Oe(r,e)||Oe(s,e)||s.push(e)}));a(r,(e=>{Me(o,e)}))}return o}function m(e){let t=[];return function e(r){Oe(t,r)||(t.push(r),h(r,e))}(X(e)),t}function h(e,t){let r=e.meta.unit;'fork'!==r&&"forkInFlightCounter"!==r&&(a(e.next,t),a(Y(e),t),a(Z(e),t))}Object.defineProperty(exports,'__esModule',{value:1});let g='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',y='store',k='map',b=e=>(R(e)||P(e))&&'kind'in e;const v=e=>t=>b(t)&&t.kind===e;let w=v(y),x=v("event"),S=v("effect"),q=v("domain");var N={__proto__:null,unit:b,store:w,event:x,effect:S,domain:q};let A=e=>{throw Error(e)},P=e=>'object'==typeof e&&null!==e,R=e=>'function'==typeof e,j=e=>{P(e)||R(e)||A('expect first argument be an object')};const C=()=>{let e=0;return()=>(++e).toString(36)};let D=C(),O=C(),M=C(),F=(e,t)=>e.bind(null,t),I=(e,t,r)=>e.bind(null,t,r);const _=(e,t,r)=>({id:O(),type:e,data:r,hasRef:t});let E=0,z=({priority:e="barrier"})=>_("barrier",0,{barrierID:++E,priority:e}),W=({from:e=y,store:t,target:r,to:a=(r?y:"stack")})=>_('mov',e===y,{from:e,store:t,to:a,target:r}),T={defined:()=>_('check',0,{type:'defined'}),changed:({store:e})=>_('check',1,{type:'changed',store:e})},$=I(_,'compute',0),H=I(_,"filter",0),B=I(_,'run',0),G=({store:e})=>W({from:"stack",target:e});var U={__proto__:null,barrier:z,mov:W,check:T,compute:$,filter:H,run:B,update:G};let J=e=>({id:O(),current:e}),K=({current:e})=>e,L=(e,{fn:t},{a:r})=>t(e,r),Q=(e,{fn:t},{a:r})=>t(r,e),V=(e,{fn:t})=>t(e),X=e=>e.graphite||e,Y=e=>e.family.owners,Z=e=>e.family.links,ee=e=>e.stateRef,te=e=>e.config,re=e=>e.ɔ,ae=e=>e.value,ne=e=>e.subscribers,oe=e=>e.parent,se=e=>e.forkPage,le=(e,t)=>{let r=X(e);for(let e=0;e<t.length;e++){let a=X(t[e]);"domain"!==r.family.type&&(a.family.type="crosslink"),Y(a).push(r),Z(r).push(a)}};const ie=(e=[])=>{let t=[];if(Array.isArray(e))for(let r=0;r<e.length;r++)Array.isArray(e[r])?t.push(...e[r]):t.push(e[r]);else t.push(e);return t.map(X)};let fe=({hasRef:e,type:t,data:r},a)=>{let n;e&&(n=r.store,a[n.id]=n),'mov'===t&&r.to===y&&(n=r.target,a[n.id]=n)},ce=null;const ue=(e,t)=>{if(!e)return t;if(!t)return e;let r,a=e.v.type===t.v.type;return(a&&e.v.id>t.v.id||!a&&"sampler"===e.v.type)&&(r=e,e=t,t=r),r=ue(e.r,t),e.r=e.l,e.l=r,e},pe=[];let de=0;for(;de<5;)pe.push({first:null,last:null,size:0}),de+=1;const me=()=>{for(let e=0;e<5;e++){let t=pe[e];if(t.size>0){if(2===e||3===e){t.size-=1;let e=ce.v;return ce=ue(ce.l,ce.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},he=(e,t,r,a,n,o)=>ge(0,{a:null,b:null,node:r,parent:a,value:n,page:t,forkPage:o},e),ge=(e,t,r,a=0)=>{let n=ye(r),o=pe[n],s={v:{idx:e,stack:t,type:r,id:a},l:0,r:0};2===n||3===n?ce=ue(ce,s):(0===o.size?o.first=s:o.last.r=s,o.last=s),o.size+=1},ye=e=>{switch(e){case'child':return 0;case'pure':return 1;case"barrier":return 2;case"sampler":return 3;case"effect":return 4;default:return-1}},ke=new Set;let be,ve=1,we=0,xe=null,Se=e=>{be=e},qe=e=>{xe=e},Ne=(e,t,r)=>{let a=xe,n=null,o=be;if(e.target&&(t=e.params,r=e.defer,a='page'in e?e.page:a,e.stack&&(n=e.stack),o=se(e)||o,e=e.target),Array.isArray(e))for(let r=0;r<e.length;r++)he('pure',a,X(e[r]),n,t[r],o);else he('pure',a,X(e),n,t,o);r&&!ve||(()=>{let e,t,r,a,n,o,s={isRoot:ve,currentPage:xe,forkPage:be,isWatch:we};ve=0;e:for(;a=me();){let{idx:l,stack:i,type:f}=a;r=i.node,xe=n=i.page,be=se(i),o=(n||r).reg;let c={fail:0,scope:r.scope};e=t=0;for(let a=l;a<r.seq.length&&!e;a++){let u=r.seq[a],p=u.data;switch(u.type){case"barrier":{let e=p.barrierID;n&&(e=`${n.fullID}_${e}`);let t=p.priority;if(a!==l||f!==t){ke.has(e)||(ke.add(e),ge(a,i,t,e));continue e}ke.delete(e);break}case'mov':{let e;switch(p.from){case"stack":e=ae(i);break;case"a":case'b':e=i[p.from];break;case"value":e=p.store;break;case y:o[p.store.id]||(i.page=n=null,o=r.reg),e=K(o[p.store.id])}switch(p.to){case"stack":i.value=e;break;case"a":case'b':i[p.to]=e;break;case y:o[p.target.id].current=e}break}case'check':switch(p.type){case'defined':t=void 0===ae(i);break;case'changed':t=ae(i)===K(o[p.store.id])}break;case"filter":t=!Ae(c,p,i);break;case'run':if(a!==l||"effect"!==f){ge(a,i,"effect");continue e}case'compute':we='watch'===r.meta.op,i.value=Ae(c,p,i),we=s.isWatch}e=c.fail||t}if(!e)for(let e=0;e<r.next.length;e++)he('child',n,r.next[e],i,ae(i),se(i))}ve=s.isRoot,xe=s.currentPage,be=se(s)})()};const Ae=(e,{fn:t},r)=>{try{return t(ae(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let Pe=(e,t)=>''+e.shortName+t,Re=(e,t)=>null==t?Pe(e,' → *'):t,je=(e,t)=>{j(e),re(e)&&t(te(e),re(e))},Ce=e=>{let t;return je(e[0],((r,a)=>{t=r,e=a})),[e,t]},De=(e,t)=>{for(let r in e)t(e[r],r)},Oe=(e,t)=>e.includes(t),Me=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)};const Fe=(e,t)=>{Me(e.next,t),Me(Y(e),t),Me(Z(e),t)},Ie=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=Z(e);for(;a=n.pop();)Fe(a,e),(t||r&&!e.meta.sample||"crosslink"===a.family.type)&&Ie(a,t,'on'!==a.meta.op&&r);for(n=Y(e);a=n.pop();)Fe(a,e),r&&"crosslink"===a.family.type&&Ie(a,t,'on'!==a.meta.op&&r)},_e=e=>e.clear();let Ee=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),w(e))_e(ne(e));else if(q(e)){r=1;let t=e.history;_e(t.events),_e(t.effects),_e(t.stores),_e(t.domains)}Ie(X(e),!!t,r)},ze=e=>{let t=I(Ee,e,void 0);return t.unsubscribe=t,t},We=e=>(Te&&le(ae(Te),[e]),e),Te=null,$e=()=>Te&&Te.template,He=e=>(e&&Te&&Te.sidRoot&&(e=`${Te.sidRoot}ɔ${e}`),e),Be=(t,r,{node:a,scope:n,meta:o})=>We(e({node:a,parent:t,child:r,scope:n,meta:o,family:{owners:[t,r],links:r}})),Ge=t=>{let r;je(t,((e,a)=>{r=e,t=a}));let{from:a,to:n,meta:o={op:'forward'}}=t;return a&&n||A('from and to fields should be defined'),r&&(o.config=r),ze(We(e({parent:a,child:n,meta:o,family:{}})))},Ue=(t,r)=>{if(R(r)||A('.watch argument should be a function'),be){let e=be.nodeMap[X(t).id];e&&(t=e)}return ze(We(e({scope:{fn:r},node:[B({fn:V})],parent:t,meta:{op:'watch'},family:{owners:t}})))};const Je=(e,t)=>(P(e)&&(Je(te(e),t),null!=e.name&&(P(e.name)?Je(e.name,t):R(e.name)?t.handler=e.name:t.name=e.name),e.loc&&(t.loc=e.loc),(e.sid||null===e.sid)&&(t.sid=e.sid),e.handler&&(t.handler=e.handler),oe(e)&&(t.parent=oe(e)),'strict'in e&&(t.strict=e.strict),e.named&&(t.named=e.named),Je(re(e),t)),t);let Ke,Le=(e,t,r="event")=>{oe(e)&&oe(e).hooks[r](t)},Qe=(e,t,a,n)=>{let o=Je({name:n,config:a},{}),s="domain"===e,l=D(),{parent:i=null,sid:f=null,strict:c=1,named:u=null}=o,p=u||o.name||(s?'':l),d=r(p,i),m={unit:t.kind=e,name:t.shortName=p,sid:t.sid=He(f),named:u,unitId:t.id=l};if(t.parent=i,t.compositeName=d,t.defaultConfig=o,t.thru=e=>e(t),t.getType=()=>d.fullName,!s){t.subscribe=e=>(j(e),t.watch(R(e)?e:t=>{e.next&&e.next(t)})),t[g]=()=>t;let e=$e();e&&(m.nativeTemplate=e)}return Ke=c,m},Ve=e=>o({named:e});const Xe=(e,t,r,a)=>Be(e,t,{scope:{fn:a},node:[$({fn:V})],meta:{op:r}}),Ye=(e,t,r,a)=>{let n;P(r)&&(n=r,r=r.fn);let s=o(Pe(e,' →? *'),n);return Be(e,s,{scope:{fn:r},node:a,meta:{op:t}}),s},Ze=(e,t,r,a,n)=>{let o=ee(t),s=[W({store:o,to:"a"}),$({fn:a?Q:L}),T.defined(),T.changed({store:o}),G({store:o})],l=$e();if(l&&(s.unshift(l.loader),s.push(l.upward),w(e))){let t=ee(e);Oe(l.plain,t)||(Oe(l.closure,t)||l.closure.push(t),o.before||(o.before=[]),o.before.push({type:'closure',of:t}))}return Be(e,t,{scope:{fn:n},node:s,meta:{op:r}})},et=e=>t=>e(...t),tt=(e,r,a,n)=>{let o=e?e=>e.slice():e=>({...e}),l=e?[]:{},i=$e(),f=o(l),c=J(f),u=J(1);c.type=e?'list':'shape',i&&i.plain.push(c,u);let p=s(f,{name:a||t(r)}),d=[T.defined(),W({store:c,to:"a"}),H({fn:(e,{key:t},{a:r})=>e!==r[t]}),W({store:u,to:'b'}),$({fn(e,{clone:t,key:r},a){a.b&&(a.a=t(a.a)),a.a[r]=e}}),W({from:"a",target:c}),W({from:"value",store:0,target:u}),z({priority:"barrier"}),W({from:"value",store:1,target:u}),W({store:c}),n&&$({fn:n}),T.changed({store:ee(p)})],m=c.before=[];return De(r,((e,t)=>{if(!w(e))return void(f[t]=l[t]=e);l[t]=e.defaultState,f[t]=e.getState();let r=Be(e,p,{scope:{key:t,clone:o},node:d,meta:{op:'combine'}}),a=ee(e);m.push({type:'field',field:t,from:a}),i&&(Oe(i.plain,a)||r.seq.unshift(i.loader))})),p.defaultShape=r,c.after=[n?{type:k,to:ee(p),fn:n}:{type:'copy',to:ee(p)}],i||(p.defaultState=n?ee(p).current=n(f):l),p};let rt=({params:e,req:t,ok:r,anyway:a,stack:n})=>o=>Ne({target:[a,at],params:[r?{status:'done',params:e,result:o}:{status:'fail',params:e,error:o},{fn:r?t.rs:t.rj,value:o}],defer:1,page:n.page,forkPage:se(n)});const at=e({node:[B({fn({fn:e,value:t}){e(t)}})],meta:{op:'fx',fx:'sidechain'}}),nt=(e,t,r)=>(e.watch((e=>{le(r,[e]),t.add(e),e.ownerSet||(e.ownerSet=t),oe(e)||(e.parent=r)})),le(r,[e]),r=>(t.forEach(r),e.watch(r)));exports.allSettled=(e,{scope:t,params:r})=>{if(!b(e))return Promise.reject(Error('first argument should be unit'));let a=i();a.parentFork=be;let{forkInFlightCounter:n}=t.graphite.scope;n.scope.defers.push(a);let o=[t.find(e)],s=[];return S(e)?s.push({params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}):s.push(r),o.push(n),s.push(null),Ne({target:o,params:s,forkPage:t}),a.req},exports.attach=e=>{let t;je(e,((r,a)=>{t=r,e=a}));let{source:r,effect:a,mapParams:n}=e;n||(n=r?(e,t)=>t:e=>e);let o,s=f(e,t),{runner:i}=X(s).scope,c=({params:e,req:t},{finally:r,effect:a},o)=>{let s,l=rt({params:e,req:t,ok:0,anyway:r,stack:o});try{s=n(e,o.a)}catch(e){return l(e)}Ne({target:a,params:{params:s,req:{rs:rt({params:e,req:t,ok:1,anyway:r,stack:o}),rj:l}},page:o.page,defer:1})};if(r){let e;w(r)?e=r:(e=l(r),le(s,[e]));let t=W({from:y,store:ee(e),to:"a"});o=[B({fn:e=>e}),t,$({fn:c})],fe(t,i.reg)}else o=[B({fn:c})];return i.scope.effect=a,i.meta.onCopy.push("effect"),i.seq.splice(0,1,...o),Le(a,s,"effect"),s},exports.clearNode=Ee,exports.combine=l,exports.createApi=(...e)=>{let[[t,r],a]=Ce(e),n={};return De(r,((e,r)=>{let s=n[r]=o(r,{parent:oe(t),config:a});t.on(s,e),Le(t,s)})),n},exports.createDomain=function t(r,a){let n=new Set,l=new Set,i=new Set,c=new Set,u=e({family:{type:"domain"}}),p={history:{domains:n,stores:l,effects:i,events:c},graphite:u};u.meta=Qe("domain",p,a,r);let[d,m,h,g]=['onEvent','onEffect','onStore','onDomain'].map(Ve);p.hooks={event:d,effect:m,store:h,domain:g},p.onCreateEvent=nt(d,c,p),p.onCreateEffect=nt(m,i,p),p.onCreateStore=nt(h,l,p),p.onCreateDomain=nt(g,n,p),p.createEvent=p.event=(e,t)=>d(o(e,{parent:p,config:t})),p.createEffect=p.effect=(e,t)=>m(f(e,{parent:p,config:t})),p.createDomain=p.domain=(e,r)=>t({name:e,parent:p,config:r}),p.createStore=p.store=(e,t)=>h(s(e,{parent:p,config:t})),We(p);let y=oe(p);return y&&(De(p.hooks,((e,t)=>{Ge({from:e,to:y.hooks[t]})})),y.hooks.domain(p)),p},exports.createEffect=f,exports.createEvent=o,exports.createNode=e,exports.createStore=s,exports.createStoreObject=l,exports.fork=(t,{values:r,handlers:n}={})=>{q(t)||A('first argument of fork should be domain');let o=!!r;r=p(r||{});let s=(t=>{function r(e){let t=X(e),r=n.indexOf(t);if(-1===r){let r='unit';e!==t&&e.id!==e.shortName&&(r=e.shortName),A(r+" not found in forked scope")}return c[r]}let n=m(t),o=new Map,s=$({fn:(e,t,r)=>(Se(se(r)),e)}),l=e({scope:{defers:[],inFlight:0,fxID:0},node:[$({fn(e,t,r){r.parent?'finally'===r.parent.node.meta.named?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1}}),z({priority:"sampler"}),B({fn(e,t){let{inFlight:r,defers:n,fxID:o}=t;r>0||0===n.length||Promise.resolve().then((()=>{t.fxID===o&&a(n.splice(0,n.length),(e=>{Se(e.parentFork),e.rs(e.value)}))}))}})],meta:{unit:"forkInFlightCounter"}}),i={},f={},c=n.map((t=>{let{seq:r,next:a,meta:n,scope:o}=t,s=e({node:r.map((e=>({id:e.id,type:e.type,data:{...e.data},hasRef:e.hasRef}))),child:[...a],meta:{forkOf:t,...n},scope:{...o}});return s.family={type:t.family.type,links:[...Z(t)],owners:[...Y(t)]},i[t.id]=s,n.sid&&(f[n.sid]=s),s})),u={};return a(c,(e=>{let{reg:t,scope:a,meta:{onCopy:n,op:i,unit:f}}=e;for(let e in t){let r=t[e],a=o.get(r);a||(a={id:r.id,current:r.current},o.set(r,a)),u[e]=t[e]=a}if(n)for(let e=0;e<n.length;e++)a[n[e]]=r(a[n[e]]);switch(h(e,((e,t,a)=>{a[t]=r(e)})),i||f){case y:e.meta.wrapped=(e=>({kind:y,getState:()=>e.reg[e.scope.state.id].current,updates:{watch:F(Ue,e)},graphite:e,family:e.family}))(e);break;case"event":e.seq.unshift(s);break;case"effect":e.next.push(l),e.seq.unshift(s);break;case'fx':a.finally.next.push(l),e.seq.unshift(s);break;case'watch':e.seq.unshift(s)}})),{cloneOf:t,nodeMap:i,sidMap:f,clones:c,find:r,reg:u,getState:e=>r(e).meta.wrapped.getState(),graphite:e({family:{type:"domain",links:[l,...c]},meta:{unit:'fork'},scope:{forkInFlightCounter:l}})}})(t);if(o&&(()=>{let e=m(t),n={},o={},l=new Set,i=new Set,f=Object.getOwnPropertyNames(r);for(let{reg:t,meta:r}of e){let{nativeTemplate:e}=r;for(let r in t)n[r]=t[r],e&&i.add(r)}for(let e of s.clones){let{reg:t}=e,{unit:a,sid:n}=e.meta;if(a===y&&n&&Oe(f,n)){let{state:a}=e.scope;t[a.id].current=r[n],l.add(a)}for(let e in t)o[e]=t[e]}a(d(u(n),i),(e=>{((e,t)=>{let r=0;if(t&&t.before&&!l.has(e))for(let a of t.before)switch(a.type){case k:e.current=a.fn(o[a.from.id].current);break;case'field':{let t=o[a.from.id];r||(r=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[a.field]=t.current;break}}if(!t||!t.after)return;let a=e.current;for(let e of t.after){let t=o[e.to.id];switch(e.type){case'copy':t.current=a;break;case k:t.current=e.fn(a)}}})(o[e],n[e])}))})(),n){n=p(n);let e=Object.keys(n);for(let{scope:t,meta:r}of s.clones)r.sid&&Oe(e,r.sid)&&(t.runner.scope.getHandler=()=>n[r.sid])}return s},exports.forward=Ge,exports.fromObservable=e=>{j(e);let t=g in e?e[g]():e;t.subscribe||A('expect observable to have .subscribe');let r=o(),a=I(Ee,r,void 0);return t.subscribe({next:r,error:a,complete:a}),r},exports.guard=(...t)=>{let r={op:'guard'},a='guard',[[n,s],i]=Ce(t);i&&(r.config=i,i.name&&(a=i.name)),s||(s=n,n=s.source);let{filter:f,greedy:u,name:p=a}=s,d=s.target||o(p,r.config);return b(n)||(n=l(n)),b(f)?c({source:f,clock:n,target:We(e({node:[H({fn:({guard:e})=>e}),$({fn:({data:e})=>e})],child:d,meta:r,family:{owners:[n,f,d],links:d}})),fn:(e,t)=>({guard:e,data:t}),greedy:u,name:p}):(R(f)||A('`filter` should be function or unit'),Be(n,d,{scope:{fn:f},node:[H({fn:V})],meta:r})),d},exports.hydrate=(e,{values:t})=>{let r=P(e)&&e.cloneOf;q(e)||r||A('first argument of hydrate should be domain or scope'),P(t)||A('values property should be an object');let n,o,s=p(t);if(r)n=[],o=[],De(s,((t,r)=>{let a=e.sidMap[r];a&&(n.push(a),o.push(t))}));else{let t=(({flatGraphUnits:e,values:t,collectWatches:r})=>{let n=[],o=[],s={},l=new Set,i=Object.getOwnPropertyNames(t);for(let a of e){let{reg:e}=a,{op:f,unit:c,sid:u}=a.meta;if(c===y&&u&&Oe(i,u)){let{state:e}=a.scope;e.current=t[u],l.add(e)}if(r&&'watch'===f){let e=a.family.owners[0];e.meta.unit===y&&(n.push(a),o.push(e.scope.state))}for(let t in e)s[t]=e[t]}return a(d(u(s)),(e=>{(e=>{let t=0;if(e.before&&!l.has(e))for(let r of e.before)switch(r.type){case k:e.current=r.fn(r.from.current);break;case'field':{let a=r.from;t||(t=1,e.current=Array.isArray(e.current)?[...e.current]:{...e.current}),e.current[r.field]=a.current;break}}if(!e.after)return;let r=e.current;for(let t of e.after){let e=t.to;switch(t.type){case'copy':e.current=r;break;case k:e.current=t.fn(r)}}})(s[e])})),{storeWatches:n,storeWatchesRefs:o}})({flatGraphUnits:m(e),values:s,collectWatches:1});n=t.storeWatches,o=t.storeWatchesRefs.map((({current:e})=>e))}Ne({target:n,params:o,forkPage:r?e:0})},exports.is=N,exports.launch=Ne,exports.merge=(e,r)=>{let a=o(r||t(e,'merge'));return Ge({from:e,to:a,meta:{op:'merge'}}),a},exports.restore=(e,t,r)=>{if(w(e))return e;if(b(e)){let a,n=oe(e);return x(e)&&(a=s(t,{parent:n,name:e.shortName,ɔ:r}).on(e,((e,t)=>t))),S(e)&&(a=s(t,{parent:n,name:e.shortName,ɔ:r}).on(e.done,((e,{result:t})=>t))),n&&n.hooks.store(a),a}let a=Array.isArray(e)?[]:{};return De(e,((e,t)=>{a[t]=w(e)?e:s(e,{name:t})})),a},exports.sample=c,exports.scopeBind=e=>{be||A('scopeBind cannot be called outside of forked .watch');let t=be.find(e),r=be;return e=>{Ne({target:t,params:e,forkPage:r})}},exports.serialize=({clones:e,getState:t,cloneOf:r},{ignore:a=[],onlyChanges:n}={})=>{let o={};if(n){a=[...a];for(let e of r.history.stores)t(e)===e.defaultState&&a.push(e)}for(let{meta:t,scope:r,reg:a}of e){if(t.unit!==y)continue;let{sid:e}=t;e&&(o[e]=a[r.state.id].current)}for(let{sid:e}of a)e&&delete o[e];return o},exports.setStoreName=(e,t)=>{let a=r(t,oe(e));if(e.shortName=t,!e.compositeName)return void(e.compositeName=a);let n=e.compositeName;n.path=a.path,n.shortName=a.shortName,n.fullName=a.fullName},exports.split=(...e)=>{let t,[[r,a],n]=Ce(e),o=!a;o&&(t=r.cases,a=r.match,r=r.source);let s={},l=w(r)?r.updates:r;if(De(a,((e,t)=>{s[t]=l.filter({fn:e,config:n}),l=l.filter({fn:t=>!e(t),config:n})})),s.__=l,!o)return s;De(s,((e,r)=>{t[r]&&Ge({from:e,to:t[r]})}))},exports.step=U,exports.version="21.7.5",exports.withFactory=({sid:t,name:r,loc:a,method:o,fn:s})=>n(e({meta:{sidRoot:He(t),name:r,loc:a,method:o}}),s),exports.withRegion=n;
//# sourceMappingURL=effector.cjs.js.map
